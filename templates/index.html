<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

    <div>
        <input id="timespan" type="number" value="120" placeholder="Enter timespan in seconds">
        <button onclick="updateTimespan()">Update Timespan</button>
    </div>

    <iframe id="webcamStream" width="700" height="500" src="http://127.0.0.1:8080"></iframe> <!-- Replace 'your-camera-ip-address' with your actual camera IP -->

    <h1>Light Control Dashboard</h1>
    <div>
        Current time: <span id="current-time"></span>
    </div>
    <div>
        Time until light turns on again: <span id="time-until-on"></span>
    </div>
    <div>
        Set Light On Time: <input type="time" id="light-on-time">
        Set Light Off Time: <input type="time" id="light-off-time">
        <button onclick="setLightTimes()">Save Times</button>
    </div>


    <div>
        <button onclick="toggleLight(true)">Turn Light ON</button>
        <button onclick="toggleLight(false)">Turn Light OFF</button>
    </div>


    <h1>Temperature (C)</h1>
    <canvas id="temperatureChart" width="400" height="100"></canvas>

    <h1>Humidity (%)</h1>
    <canvas id="humidityChart" width="400" height="100"></canvas>

    <h1>eCO2 (ppm)</h1>
    <canvas id="eco2Chart" width="400" height="100"></canvas>

    <h1>TVOC (ppb)</h1>
    <canvas id="tvocChart" width="400" height="100"></canvas>

    <script>
        function updateTime() {
            document.getElementById('current-time').innerText = new Date().toLocaleTimeString();
            setTimeout(updateTime, 1000);
        }

        function setLightTimes() {
            const onTime = document.getElementById('light-on-time').value;
            const offTime = document.getElementById('light-off-time').value;
            fetch('/set-light-times', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ onTime, offTime })
            }).then(response => response.json())
            .then(data => console.log(data));
        }

        updateTime(); // Initialize the time update

        function toggleLight(state) {
            $.ajax({
                url: '/light/control',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({state: state}),
                success: function(response) {
                    console.log("Response: " + JSON.stringify(response));
                },
                error: function(xhr, status, error) {
                    console.log("Error: " + error);
                    console.log("Status: " + status);
                    console.dir(xhr);
                }
            });
        }



        var timespan = 120; // default timespan

        function movingAverage(data, period) {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    // Not enough data to calculate the moving average, use the actual data instead
                    result.push(data[i]);
                } else {
                    // Calculate the sum of the 'period' number of entries, including the current one
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j];
                    }
                    // Calculate the average and add it to the result array
                    result.push(sum / period);
                }
            }
            return result;
        }


        function sampleData(data, sampleRate) {
            return data.filter((_, index) => index % sampleRate === 0);
        }


        function averageData(data, interval) {
            let result = [];
            for (let i = 0; i < data.length; i += interval) {
                let sum = 0;
                let count = 0;
                for (let j = i; j < i + interval && j < data.length; j++) {
                    sum += data[j];
                    count++;
                }
                result.push(sum / count);
            }
            return result;
        }


        function updateTimespan() {
            var newTimespan = document.getElementById('timespan').value;
            timespan = parseInt(newTimespan, 10);
            fetchData(); // Immediately fetch new data with the updated timespan
        }

        // Define the chart configurations
        var tempCtx = document.getElementById('temperatureChart').getContext('2d');
        var temperatureChart = new Chart(tempCtx, createChartConfig('Temperature (C)', 'rgb(255, 99, 132)'));
        var humidCtx = document.getElementById('humidityChart').getContext('2d');
        var humidityChart = new Chart(humidCtx, createChartConfig('Humidity (%)', 'rgb(54, 162, 235)'));
        var eco2Ctx = document.getElementById('eco2Chart').getContext('2d');
        var eco2Chart = new Chart(eco2Ctx, createChartConfig('eCO2 (ppm)', 'rgb(75, 192, 192)'));
        var tvocCtx = document.getElementById('tvocChart').getContext('2d');
        var tvocChart = new Chart(tvocCtx, createChartConfig('TVOC (ppb)', 'rgb(153, 102, 255)'));

        function createChartConfig(label, borderColor) {
            return {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        borderColor: borderColor,
                        data: []
                    }]
                },
                options: {
                    scales: {
                        x: {  // Updated configuration for Chart.js v3
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'last 24 hours'
                            },
                        }
                    }
                }
            };
        }

        function updateChart(chart, data) {
            console.log("Updating chart with data:", data);

            if (data[0].length === 0) {
                console.log("Data array is empty, resetting chart data.");
                chart.data.labels = [];
                chart.data.datasets.forEach((dataset) => {
                    dataset.data = [];
                });
            } else {
                // Assuming you have a way to generate labels or you use a simple index for labels
                chart.data.labels = data[0].map((_, index) => index); // Update labels if necessary
                chart.data.datasets.forEach((dataset, index) => {
                    dataset.data = data[index]; // Update data within the dataset
                });
            }
            chart.update(); // Redraw the chart
        }

        function fetchData() {
            $.ajax({
                url: '/data?timespan=' + timespan,
                success: function(data) {
                    console.log("Received data for charts:", data);  // Debug print
                    if (data && data.length > 0) {
                        var temps = data.map(d => d[0]);
                        var humids = data.map(d => d[1]);
                        var eco2s = data.map(d => d[2]);
                        var tvocs = data.map(d => d[3]);
                        
                        updateChart(temperatureChart, [temps]);
                        updateChart(humidityChart, [humids]);
                        updateChart(eco2Chart, [eco2s]);
                        updateChart(tvocChart, [tvocs]);
                    } else {
                        console.log("No data received, clearing charts");
                        updateChart(temperatureChart, [[]]);
                        updateChart(humidityChart, [[]]);
                        updateChart(eco2Chart, [[]]);
                        updateChart(tvocChart, [[]]);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Failed to fetch data:", error);
                }
            });
        }


        setInterval(fetchData, 3000);
    </script>
</body>
</html>
